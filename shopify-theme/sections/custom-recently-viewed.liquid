{% comment %}
  ============================================
  Recently Viewed Products
  Paste into: sections/custom-recently-viewed.liquid

  NOTE: This section needs to be added to BOTH:
  1. Homepage (to display the list)
  2. Product pages (to record views) â€” add via Theme Customizer on product template
  ============================================
{% endcomment %}

<section class="recently-viewed section-{{ section.id }}-padding" id="recentlyViewed-{{ section.id }}" style="display: none;">
  <div class="page-width">
    <h2 class="recently-viewed__heading">{{ section.settings.heading | default: 'Recently Viewed' }}</h2>
    <div class="recently-viewed__grid" id="recentlyViewedGrid-{{ section.id }}"></div>
  </div>
</section>

<script>
(function() {
  var MAX_ITEMS = {{ section.settings.max_items | default: 6 }};
  var STORAGE_KEY = 'cv_recently_viewed';
  var sectionId = '{{ section.id }}';

  /* On product pages, save the current product */
  {% if template.name == 'product' %}
  (function saveProduct() {
    var product = {
      handle: '{{ product.handle }}',
      title: {{ product.title | json }},
      url: '{{ product.url }}',
      image: '{{ product.featured_image | image_url: width: 300 }}',
      price: '{{ product.price | money }}'
    };
    try {
      var items = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      items = items.filter(function(p) { return p.handle !== product.handle; });
      items.unshift(product);
      items = items.slice(0, MAX_ITEMS);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    } catch(e) {}
  })();
  {% endif %}

  /* Render recently viewed */
  try {
    var items = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (items.length > 0) {
      var section = document.getElementById('recentlyViewed-' + sectionId);
      var grid = document.getElementById('recentlyViewedGrid-' + sectionId);
      section.style.display = 'block';

      grid.innerHTML = items.map(function(p) {
        return '<a href="' + p.url + '" class="recently-viewed__card">'
          + '<div class="recently-viewed__image"><img src="' + p.image + '" alt="' + p.title.replace(/"/g, '&quot;') + '" loading="lazy"></div>'
          + '<h3 class="recently-viewed__title">' + p.title + '</h3>'
          + '<p class="recently-viewed__price">' + p.price + '</p>'
          + '</a>';
      }).join('');
    }
  } catch(e) {}
})();
</script>

<style>
  .recently-viewed__heading {
    font-family: var(--font-heading-family, 'Trirong', serif);
    font-size: 2rem;
    font-weight: 300;
    text-align: center;
    margin-bottom: 24px;
  }
  .recently-viewed__grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 16px;
  }
  .recently-viewed__card {
    text-decoration: none;
    color: inherit;
    text-align: center;
  }
  .recently-viewed__image {
    aspect-ratio: 1;
    overflow: hidden;
    margin-bottom: 8px;
    background: var(--color-background, #efecec);
    border-radius: 4px;
  }
  .recently-viewed__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
  }
  .recently-viewed__card:hover img { transform: scale(1.05); }
  .recently-viewed__title {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 4px;
    line-height: 1.3;
  }
  .recently-viewed__price {
    font-size: 0.75rem;
    opacity: 0.5;
  }

  @media (max-width: 749px) {
    .recently-viewed__grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
  }
</style>

{% schema %}
{
  "name": "Recently Viewed",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Recently Viewed"
    },
    {
      "type": "range",
      "id": "max_items",
      "label": "Max items to show",
      "min": 3,
      "max": 8,
      "step": 1,
      "default": 6
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed"
    }
  ]
}
{% endschema %}
